"use client"

import { useState } from "react"
import { ColumnDef } from "@tanstack/react-table"
import { MoreHorizontal, Plus, Mail, Phone, Calendar, MapPin, Briefcase, Star, Users, Building, CheckCircle } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { DataTable } from "@/components/custom/data-table"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { useUsers } from "@/hooks/useUsers"
import { User } from "@/types/user"
import { FadeIn } from "@/components/custom/animations"
import { useToast } from "@/components/custom/feedback"
import { LoadingOverlay, RefreshButton } from "@/components/custom/loading"
import { StatCard, StatsGrid } from "@/components/common"

const statusMap = {
  active: { label: "Ativo", color: "bg-green-500" },
  inactive: { label: "Inativo", color: "bg-gray-500" },
  pending: { label: "Pendente", color: "bg-yellow-500" },
}

export default function AdvancedTeamPage() {
  const { users, loading, refetch } = useUsers()
  const { addNotification } = useToast()

  const columns: ColumnDef<User>[] = [
    {
      accessorKey: "name",
      header: "Membro",
      cell: ({ row }) => {
        const user = row.original
        return (
          <div className="flex items-center gap-3">
            <Avatar>
              <AvatarImage src={user.avatar} alt={user.name} />
              <AvatarFallback>
                {user.name.split(' ').map(n => n[0]).join('').slice(0, 2)}
              </AvatarFallback>
            </Avatar>
            <div>
              <div className="font-medium">{user.name}</div>
              <div className="text-sm text-muted-foreground">{user.email}</div>
            </div>
          </div>
        )
      },
    },
    {
      accessorKey: "role",
      header: "Cargo",
      cell: ({ row }) => (
        <Badge variant="secondary">{row.getValue("role")}</Badge>
      ),
    },
    {
      accessorKey: "status",
      header: "Status",
      cell: ({ row }) => {
        const status = row.getValue("status") as keyof typeof statusMap
        return (
          <div className="flex items-center gap-2">
            <div className={`h-2 w-2 rounded-full ${statusMap[status]?.color}`} />
            <span>{statusMap[status]?.label}</span>
          </div>
        )
      },
      filterFn: (row, id, value) => {
        return value === "all" || row.getValue(id) === value
      },
    },
    {
      accessorKey: "createdAt",
      header: "Admissão",
      cell: ({ row }) => {
        const date = new Date(row.getValue("createdAt"))
        return date.toLocaleDateString('pt-BR')
      },
    },
    {
      id: "actions",
      cell: ({ row }) => {
        const user = row.original
        return (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">Abrir menu</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuLabel>Ações</DropdownMenuLabel>
              <DropdownMenuItem onClick={() => addNotification({
                type: "info",
                message: `E-mail enviado para ${user.name}`,
              })}>
                <Mail className="mr-2 h-4 w-4" />
                Enviar E-mail
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => addNotification({
                type: "info", 
                message: `Ligando para ${user.name}...`,
              })}>
                <Phone className="mr-2 h-4 w-4" />
                Ligar
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => addNotification({
                type: "success",
                message: `Reunião agendada com ${user.name}`,
              })}>
                <Calendar className="mr-2 h-4 w-4" />
                Agendar Reunião
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem>
                Editar Perfil
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem className="text-destructive">
                Desativar Membro
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        )
      },
    },
  ]

  const handleRowClick = (user: User) => {
    addNotification({
        type: 'info',
        title: 'Membro Selecionado',
        message: `Você selecionou ${user.name}.`
    })
  }

  const activeUsers = users.filter(u => u.status === 'active').length
  const roles = new Set(users.map(u => u.role)).size

  const stats = [
    { title: "Total de Membros", value: users.length.toString(), icon: Users, color: "text-blue-600" },
    { title: "Membros Ativos", value: activeUsers.toString(), icon: CheckCircle, color: "text-green-600" },
    { title: "Cargos Diferentes", value: roles.toString(), icon: Briefcase, color: "text-purple-600" },
  ]

  return (
    <LoadingOverlay isLoading={loading} message="Carregando membros da equipe...">
        <div className="flex-1 space-y-6">
            <FadeIn>
                <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight">Equipe Avançada</h1>
                    <p className="text-muted-foreground">
                    Gestão completa da equipe com filtros e análises
                    </p>
                </div>
                <div className="flex gap-2">
                    <RefreshButton onRefresh={refetch} />
                    <Button onClick={() => addNotification({
                        type: "info",
                        message: "Formulário de novo membro aberto",
                    })}>
                    <Plus className="mr-2 h-4 w-4" />
                    Adicionar Membro
                    </Button>
                </div>
                </div>
            </FadeIn>

            <FadeIn delay={200}>
                <StatsGrid>
                    {stats.map(stat => (
                        <StatCard 
                            key={stat.title}
                            title={stat.title}
                            value={stat.value}
                            icon={stat.icon}
                            iconColor={stat.color}
                        />
                    ))}
                </StatsGrid>
            </FadeIn>

            <FadeIn delay={400}>
                <DataTable
                columns={columns}
                data={users}
                searchKey="name"
                searchPlaceholder="Buscar membros por nome, email ou cargo..."
                loading={loading}
                filters={[
                    {
                    key: "status",
                    label: "Status",
                    options: [
                        { label: "Ativo", value: "active" },
                        { label: "Inativo", value: "inactive" },
                        { label: "Pendente", value: "pending" },
                    ],
                    },
                    {
                    key: "role",
                    label: "Cargo",
                    options: Array.from(new Set(users.map(u => u.role))).map(role => ({ label: role, value: role })),
                    }
                ]}
                enableRowSelection={true}
                enableColumnVisibility={true}
                enableExport={true}
                pageSize={10}
                onRowClick={handleRowClick}
                onRefresh={refetch}
                />
            </FadeIn>
        </div>
    </LoadingOverlay>
  )
}