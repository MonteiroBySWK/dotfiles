"use client";

import React, { useState, useMemo, useEffect } from "react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Plus,
  Calendar,
  ChevronLeft,
  ChevronRight,
  CheckCircle2,
  PlayCircle,
  AlertCircle,
  PauseCircle,
  Clock,
  MoreHorizontal,
  Edit,
  Trash2,
  Users,
} from "lucide-react";
import { useTasks } from "@/hooks/useTasks";
import { useProjects } from "@/hooks/useProjects";
import { useUsers } from "@/hooks/useUsers";
import { Task } from "@/types/task";
import { Project } from "@/types/project";
import { User } from "@/types/user";
import { LoadingSpinner } from "@/components/custom/loading";
import { useToast } from "@/components/custom/feedback";

type GanttTask = Task & {
  assignee?: User;
  project?: Project;
};

// Funções auxiliares
const getStatusColor = (status: string) => {
  switch (status) {
    case "completed":
      return "bg-green-500";
    case "in-progress":
      return "bg-blue-500";
    case "delayed":
      return "bg-red-500";
    case "paused":
      return "bg-yellow-500";
    case "todo":
      return "bg-gray-400";
    default:
      return "bg-gray-400";
  }
};

const getStatusBadgeColor = (status: string) => {
  switch (status) {
    case "completed":
      return "bg-green-100 text-green-800";
    case "in-progress":
      return "bg-blue-100 text-blue-800";
    case "delayed":
      return "bg-red-100 text-red-800";
    case "paused":
      return "bg-yellow-100 text-yellow-800";
    case "todo":
      return "bg-gray-100 text-gray-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
};

const getPriorityColor = (priority: string) => {
  switch (priority) {
    case "urgent":
      return "bg-red-500";
    case "high":
      return "bg-orange-500";
    case "medium":
      return "bg-yellow-500";
    case "low":
      return "bg-green-500";
    default:
      return "bg-gray-500";
  }
};

const getStatusIcon = (status: string) => {
  switch (status) {
    case "completed":
      return <CheckCircle2 className="h-4 w-4" />;
    case "in-progress":
      return <PlayCircle className="h-4 w-4" />;
    case "delayed":
      return <AlertCircle className="h-4 w-4" />;
    case "paused":
      return <PauseCircle className="h-4 w-4" />;
    default:
      return <Clock className="h-4 w-4" />;
  }
};

// Componente principal
export default function Gantt({ projectId }: { projectId?: string }) {
  const {
    tasks: allTasks,
    loading: tasksLoading,
    createTask,
    updateTask,
    deleteTask,
  } = useTasks();
  const { projects, loading: projectsLoading } = useProjects();
  const { users, loading: usersLoading } = useUsers();
  const { addNotification } = useToast();

  const [selectedProject, setSelectedProject] = useState<string>(
    projectId || "all"
  );
  const [selectedStatus, setSelectedStatus] = useState<string>("all");
  const [viewMode, setViewMode] = useState<"days" | "weeks" | "months">("weeks");
  const [currentDate, setCurrentDate] = useState(new Date());
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [editingTask, setEditingTask] = useState<GanttTask | null>(null);

  useEffect(() => {
    if (projectId) {
      setSelectedProject(projectId);
    }
  }, [projectId]);

  // Filtros e Mapeamento
  const ganttTasks = useMemo(() => {
    const tasksWithDetails = allTasks.map((task) => ({
      ...task,
      assignee: users.find((u) => u.id === task.assigneeId),
      project: projects.find((p) => p.id === task.projectId),
    }));

    return tasksWithDetails.filter((task) => {
      const matchesProject =
        selectedProject === "all" || task.projectId === selectedProject;
      const matchesStatus = selectedStatus === "all" || task.status === selectedStatus;
      return matchesProject && matchesStatus;
    });
  }, [allTasks, users, projects, selectedProject, selectedStatus]);

  // Geração do calendário
  const generateCalendarDays = () => {
    const days = [];
    const startDate = new Date(currentDate);
    const range = viewMode === "days" ? 15 : viewMode === "weeks" ? 30 : 90;
    startDate.setDate(startDate.getDate() - Math.floor(range / 2));

    for (let i = 0; i < range; i++) {
      const date = new Date(startDate);
      date.setDate(date.getDate() + i);
      days.push(date);
    }
    return days;
  };

  const calendarDays = generateCalendarDays();

  // Calcular posição e largura das barras
  const getTaskBarStyle = (task: GanttTask) => {
    if (!task.startDate || !task.dueDate) return { left: "0%", width: "0%" };
    const startDate = new Date(task.startDate);
    const endDate = new Date(task.dueDate);
    const firstDay = calendarDays[0];
    const lastDay = calendarDays[calendarDays.length - 1];

    const totalTime = lastDay.getTime() - firstDay.getTime();
    const startOffset = startDate.getTime() - firstDay.getTime();
    const duration = endDate.getTime() - startDate.getTime();

    const left = (startOffset / totalTime) * 100;
    const width = (duration / totalTime) * 100;

    return {
      left: `${Math.max(0, left)}%`,
      width: `${Math.min(width, 100 - left)}%`,
    };
  };

  // Handlers
  const handleAddTask = () => {
    setEditingTask(null);
    setShowTaskModal(true);
  };

  const handleEditTask = (task: GanttTask) => {
    setEditingTask(task);
    setShowTaskModal(true);
  };

  const handleDeleteTask = async (taskId: string) => {
    try {
      await deleteTask(taskId);
      addNotification({ type: "success", message: "Tarefa excluída com sucesso!" });
    } catch (error) {
      addNotification({ type: "error", message: "Erro ao excluir tarefa." });
    }
  };

  const handleSaveTask = async (taskData: Partial<Task>) => {
    try {
      if (editingTask) {
        await updateTask(editingTask.id, taskData);
        addNotification({ type: "success", message: "Tarefa atualizada com sucesso!" });
      } else {
        const newTaskData: Omit<Task, "id"> = {
          title: taskData.title || "Nova Tarefa",
          status: "todo",
          priority: "medium",
          ...taskData,
        };
        await createTask(newTaskData);
        addNotification({ type: "success", message: "Tarefa criada com sucesso!" });
      }
      setShowTaskModal(false);
      setEditingTask(null);
    } catch (error) {
      addNotification({ type: "error", message: "Erro ao salvar tarefa." });
    }
  };

  const navigateCalendar = (direction: "prev" | "next") => {
    const newDate = new Date(currentDate);
    const daysToMove = viewMode === "days" ? 7 : viewMode === "weeks" ? 14 : 30;

    if (direction === "prev") {
      newDate.setDate(newDate.getDate() - daysToMove);
    } else {
      newDate.setDate(newDate.getDate() + daysToMove);
    }

    setCurrentDate(newDate);
  };

  if (tasksLoading || projectsLoading || usersLoading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>
            Visualização Gantt{projectId ? ` - Projeto ${projectId}` : ""}
          </CardTitle>
        </CardHeader>
        <CardContent className="flex justify-center items-center min-h-[400px]">
          <LoadingSpinner />
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4 p-4">
      <Card>
        <CardHeader className="pb-4">
          <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">