import { useState, useEffect, useRef } from "react";
import TitleSection from "../components/ui/TitleSection";
import type { dataProject } from "../constants/ProjectData";
import image_project from "../assets/image_project.webp";
import { dataProjectArr } from "../constants/ProjectData";
import { ArrowBigLeft, ArrowBigRight } from "lucide-react";
import Section from "../components/ui/Section";

const checkColorStatus = (status: "FINISHED" | "IN_PROGRESS" | "MODELING") => {
// ... (código do checkColorStatus permanece o mesmo)
  if (status === "FINISHED") {
    return "text-green-800 bg-green-200 border-green-700";
  }

  if (status === "IN_PROGRESS") {
    return "text-blue-800 bg-blue-200 border-blue-700";
  }

  if (status === "MODELING") {
    return "text-purple-800 bg-purple-200 border-purple-700";
  }
};

const ProjectItem = ({ data }: { data: dataProject }) => {
  return (
    <div className="flex flex-col md:flex-row border border-border p-4 text-txt-primary w-full flex-shrink-0">
      <div className="relative w-full md:w-1/3">
        <img src={image_project} className="object-cover w-full h-48 md:h-full" alt={data.name} />
        <span
          className={`px-2 py-0.5 absolute top-0 left-0 z-1 text-xs sm:text-sm ${checkColorStatus(
            data.status
          )}`}
        >
          {data.status}
        </span>
      </div>

      <div className="px-0 md:px-4 w-full md:w-2/3 mt-4 md:mt-0">
        <h3 className="font-extrabold text-primary text-xl sm:text-2xl mb-2.5">
          {data.name}
        </h3>
        <p className="mb-4 text-sm sm:text-base">{data.description}</p>
        <div className="flex gap-2 flex-wrap mb-6">
          {data.technologies.map((e, i) => (
            <span key={i} className="px-2 sm:px-3 py-0.5 bg-card text-xs sm:text-sm">
              {e}
            </span>
          ))}
        </div>
        <a
          href={data.url}
          className="flex w-fit justify-center items-center gap-x-1 bg-primary py-1 px-3 transition-all duration-200 hover:scale-105 text-sm sm:text-base"
        >
          Ver Github
        </a>
      </div>
    </div>
  );
};

export default function NewProjects() {
  const [currentIndex, setCurrentIndex] = useState(0);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);
  const touchStartX = useRef(0);

  const resetTimeout = () => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
  };

  useEffect(() => {
    resetTimeout();
    timeoutRef.current = setTimeout(
      () =>
        setCurrentIndex((prevIndex) =>
          prevIndex === dataProjectArr.length - 1 ? 0 : prevIndex + 1
        ),
      5000 // muda a cada 5 segundos
    );

    return () => {
      resetTimeout();
    };
  }, [currentIndex]);

  const goToSlide = (slideIndex: number) => {
    setCurrentIndex(slideIndex);
  };

  const handleTouchStart = (e: React.TouchEvent) => {
    touchStartX.current = e.touches[0].clientX;
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    if (touchStartX.current === 0) {
      return;
    }

    const touchEndX = e.touches[0].clientX;
    const diff = touchStartX.current - touchEndX;

    // Swipe left
    if (diff > 50) {
      goToSlide(currentIndex === dataProjectArr.length - 1 ? 0 : currentIndex + 1);
      touchStartX.current = 0;
    }

    // Swipe right
    if (diff < -50) {
      goToSlide(currentIndex === 0 ? dataProjectArr.length - 1 : currentIndex - 1);
      touchStartX.current = 0;
    }
  };

  return (
    <Section id="new-projects" className="h-screen max-w-7xl flex flex-col items-center justify-center mx-auto">
      <TitleSection>Projetos Recentes</TitleSection>

      <div className="w-full max-w-4xl mx-auto overflow-hidden relative" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove}>
        <div
          className="flex transition-transform ease-out duration-500"
          style={{ transform: `translateX(-${currentIndex * 100}%)` }}
        >
          {dataProjectArr.map((project, index) => (
            <ProjectItem data={project} key={index} />
          ))}
        </div>

        {/* Navegação (Setas) - Opcional, mais útil em desktop */}
        <div className="absolute top-1/2 -translate-y-1/2 w-full flex justify-between px-2">
            <button onClick={() => goToSlide(currentIndex === 0 ? dataProjectArr.length - 1 : currentIndex - 1)} className="text-white bg-black/30 p-1 rounded-full hover:bg-black/50 transition"><ArrowBigLeft /></button>
            <button onClick={() => goToSlide(currentIndex === dataProjectArr.length - 1 ? 0 : currentIndex + 1)} className="text-white bg-black/30 p-1 rounded-full hover:bg-black/50 transition"><ArrowBigRight /></button>
        </div>
      </div>

      <div className="flex justify-center gap-x-2 mt-4">
        {dataProjectArr.map((_, index) => (
          <div
            key={index}
            onClick={() => goToSlide(index)}
            className={`size-3 rounded-full cursor-pointer transition-all ${
              currentIndex === index ? "bg-primary scale-125" : "bg-gray-500"
            }`}
          ></div>
        ))}
      </div>
    </Section>
  );
}
