import { useState, useEffect, useRef, useCallback } from "react";
import TitleSection from "../components/ui/TitleSection";
import type { dataProject } from "../constants/ProjectData";
import image_project from "../assets/image_project.webp";
import { dataProjectArr } from "../constants/ProjectData";
import Section from "../components/ui/Section";

const checkColorStatus = (status: "FINISHED" | "IN_PROGRESS" | "MODELING") => {
  if (status === "FINISHED") {
    return "text-green-800 bg-green-200 border-green-700";
  }
  if (status === "IN_PROGRESS") {
    return "text-blue-800 bg-blue-200 border-blue-700";
  }
  if (status === "MODELING") {
    return "text-purple-800 bg-purple-200 border-purple-700";
  }
};

const ProjectItem = ({
  data,
  isActive,
  onClick,
}: {
  data: dataProject;
  isActive: boolean;
  onClick: () => void;
}) => {
  return (
    <div
      onClick={onClick}
      className={`flex flex-col md:flex-row border border-border p-4 text-txt-primary w-full flex-shrink-0 transition-all duration-500 ${
        isActive
          ? "opacity-100 scale-100"
          : "opacity-50 scale-90 hover:opacity-70"
      } ${!isActive && "cursor-pointer"}`}
    >
      <div className="relative w-full md:w-1/3">
        <img
          src={image_project}
          className="object-cover w-full h-48 md:h-full"
          alt={data.name}
        />
        <span
          className={`px-2 py-0.5 absolute top-0 left-0 z-1 text-xs sm:text-sm ${checkColorStatus(
            data.status
          )}`}
        >
          {data.status}
        </span>
      </div>
      <div className="px-0 md:px-4 w-full md:w-2/3 mt-4 md:mt-0">
        <h3 className="font-extrabold text-primary text-xl sm:text-2xl mb-2.5">
          {data.name}
        </h3>
        <p className="mb-4 text-sm sm:text-base">{data.description}</p>
        <div className="flex gap-2 flex-wrap mb-6">
          {data.technologies.map((e, i) => (
            <span
              key={i}
              className="px-2 sm:px-3 py-0.5 bg-card text-xs sm:text-sm"
            >
              {e}
            </span>
          ))}
        </div>
        <a
          href={data.url}
          className="flex w-fit justify-center items-center gap-x-1 bg-primary py-1 px-3 transition-all duration-200 hover:scale-105 text-sm sm:text-base"
        >
          Ver Github
        </a>
      </div>
    </div>
  );
};

export default function NewProjects() {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isPaused, setIsPaused] = useState(false);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);
  const touchStartX = useRef(0);

  const nextSlide = useCallback(() => {
    setCurrentIndex((prevIndex) =>
      prevIndex === dataProjectArr.length - 1 ? 0 : prevIndex + 1
    );
  }, []);

  const prevSlide = () => {
    setCurrentIndex((prevIndex) =>
      prevIndex === 0 ? dataProjectArr.length - 1 : prevIndex - 1
    );
  };

  const resetTimeout = () => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
  };

  useEffect(() => {
    resetTimeout();
    if (!isPaused) {
      timeoutRef.current = setTimeout(nextSlide, 5000);
    }
    return () => {
      resetTimeout();
    };
  }, [currentIndex, isPaused, nextSlide]);

  const goToSlide = (slideIndex: number) => {
    setCurrentIndex(slideIndex);
  };

  const handleTouchStart = (e: React.TouchEvent) => {
    touchStartX.current = e.touches[0].clientX;
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    if (touchStartX.current === 0) return;
    const touchEndX = e.touches[0].clientX;
    const diff = touchStartX.current - touchEndX;
    if (Math.abs(diff) > 50) {
      if (diff > 0) {
        nextSlide();
      } else {
        prevSlide();
      }
      touchStartX.current = 0;
    }
  };

  return (
    <Section
      id="projects"
      className="h-screen max-w-full flex flex-col items-center justify-center mx-auto"
    >
      <TitleSection>Projetos</TitleSection>
      <div
        className="w-full flex items-center justify-center"
        onMouseEnter={() => setIsPaused(true)}
        onMouseLeave={() => setIsPaused(false)}
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
      >
        <div className="w-[200%] h-[400px] relative">
          {dataProjectArr.map((project, index) => {
            const offset = currentIndex - index;
            // Apenas slides próximos são renderizados e visíveis
            const isVisible = Math.abs(offset) <= 2;

            return (
              <div
                key={project.name}
                className="absolute top-0 left-0 w-1/2 h-full transition-all duration-500 ease-out"
                style={{
                  transform: `translateX(calc(${offset * 50}% + ${
                    offset * 10
                  }px)) scale(${
                    index === currentIndex ? 1 : 0.8
                  })`,
                  opacity: Math.abs(offset) > 1 ? 0 : 1,
                  zIndex: dataProjectArr.length - Math.abs(offset),
                  pointerEvents: isVisible ? "auto" : "none",
                }}
              >
                <ProjectItem
                  data={project}
                  isActive={index === currentIndex}
                  onClick={() => goToSlide(index)}
                />
              </div>
            );
          })}
        </div>
      </div>

      <div className="flex justify-center gap-x-2 mt-6">
        {dataProjectArr.map((_, index) => (
          <div
            key={index}
            onClick={() => goToSlide(index)}
            className={`size-3 rounded-full cursor-pointer transition-all ${
              currentIndex === index ? "bg-primary scale-125" : "bg-gray-500"
            }`}
          ></div>
        ))}
      </div>
    </Section>
  );
}
