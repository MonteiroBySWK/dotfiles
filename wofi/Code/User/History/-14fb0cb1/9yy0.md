# ğŸ§ª Guia de Testes - Sistema SGI

## ğŸ“‹ VisÃ£o Geral

Este documento apresenta a estrutura completa de testes implementada para o sistema SGI, seguindo os princÃ­pios da **Clean Architecture** e cobrindo autenticaÃ§Ã£o, autorizaÃ§Ã£o (RBAC) e polÃ­ticas de acesso.

## ğŸ—ï¸ Estrutura de Testes

### ğŸ“ OrganizaÃ§Ã£o por Camadas

```
src/test/java/
â””â”€â”€ br/org/cesjo/sgi/
    â”œâ”€â”€ domain/                    # Testes de DomÃ­nio (Entidades)
    â”‚   â”œâ”€â”€ user/
    â”‚   â”‚   â””â”€â”€ UserTest.java
    â”‚   â””â”€â”€ rbac/
    â”‚       â”œâ”€â”€ RoleTest.java
    â”‚       â”œâ”€â”€ PermissionTest.java
    â”‚       â””â”€â”€ AccessPolicyTest.java
    â”œâ”€â”€ application/               # Testes de Casos de Uso
    â”‚   â””â”€â”€ usecases/
    â”‚       â”œâ”€â”€ auth/
    â”‚       â”‚   â””â”€â”€ AuthenticationServiceTest.java
    â”‚       â””â”€â”€ rbac/
    â”‚           â””â”€â”€ AccessControlServiceTest.java
    â””â”€â”€ infra/                     # Testes de Infraestrutura
        â”œâ”€â”€ controllers/
        â”‚   â””â”€â”€ AuthControllerTest.java
        â””â”€â”€ tests/
            â””â”€â”€ ApplicationContextTest.java
```

## ğŸ§ª Tipos de Testes

### 1. ğŸ›ï¸ Testes de DomÃ­nio (Unit Tests)

#### User Entity Tests
- âœ… CriaÃ§Ã£o de usuÃ¡rios
- âœ… ValidaÃ§Ã£o de campos obrigatÃ³rios
- âœ… Gerenciamento de roles
- âœ… Controle de tentativas de login
- âœ… Bloqueio de contas
- âœ… Igualdade e hashCode

#### Role Entity Tests
- âœ… CriaÃ§Ã£o de roles
- âœ… Gerenciamento de permissÃµes
- âœ… ValidaÃ§Ã£o de dados
- âœ… Imutabilidade de coleÃ§Ãµes

#### Permission Entity Tests
- âœ… CriaÃ§Ã£o de permissÃµes
- âœ… ValidaÃ§Ã£o de resource:action
- âœ… GeraÃ§Ã£o de full permission string
- âœ… Igualdade baseada em name, resource e action

#### Access Policy Tests
- âœ… Contexto de polÃ­ticas
- âœ… CondiÃ§Ãµes customizadas
- âœ… PolÃ­ticas baseadas em tempo
- âœ… PolÃ­ticas baseadas em rede
- âœ… PolÃ­ticas baseadas em atributos
- âœ… IntegraÃ§Ã£o complexa de polÃ­ticas

### 2. ğŸ”§ Testes de AplicaÃ§Ã£o (Service Tests)

#### AuthenticationService Tests
- âœ… AutenticaÃ§Ã£o bem-sucedida
- âœ… Falhas de autenticaÃ§Ã£o
- âœ… UsuÃ¡rios inativos/bloqueados
- âœ… Incremento de tentativas falhas
- âœ… Refresh token
- âœ… Auditoria de tentativas
- âœ… ValidaÃ§Ã£o de dependÃªncias

#### AccessControlService Tests
- âœ… Controle de acesso por permissÃµes
- âœ… Controle de acesso por polÃ­ticas
- âœ… MÃºltiplas roles do usuÃ¡rio
- âœ… CriaÃ§Ã£o de roles e permissÃµes
- âœ… AtribuiÃ§Ã£o de permissÃµes a roles
- âœ… Auditoria de operaÃ§Ãµes
- âœ… Tratamento de erros

### 3. ğŸŒ Testes de Infraestrutura (Integration Tests)

#### AuthController Tests
- âœ… Endpoint de login
- âœ… Endpoint de registro
- âœ… Endpoint de refresh token
- âœ… Endpoint de logout
- âœ… ValidaÃ§Ã£o de dados de entrada
- âœ… Tratamento de erros
- âœ… CÃ³digos de resposta HTTP

## ğŸš€ Como Executar os Testes

### Executar Todos os Testes
```bash
mvn test
```

### Executar Testes por Categoria

#### Testes de DomÃ­nio
```bash
# Testes de User
mvn test -Dtest=UserTest

# Testes de Role
mvn test -Dtest=RoleTest

# Testes de Permission
mvn test -Dtest=PermissionTest

# Testes de Access Policy
mvn test -Dtest=AccessPolicyTest
```

#### Testes de AplicaÃ§Ã£o
```bash
# Testes de AuthenticationService
mvn test -Dtest=AuthenticationServiceTest

# Testes de AccessControlService
mvn test -Dtest=AccessControlServiceTest
```

#### Testes de Infraestrutura
```bash
# Testes de AuthController
mvn test -Dtest=AuthControllerTest

# Teste de contexto da aplicaÃ§Ã£o
mvn test -Dtest=ApplicationContextTest
```

### Executar Testes com RelatÃ³rio de Cobertura
```bash
mvn test jacoco:report
```

### Executar Testes em Modo Debug
```bash
mvn test -Dtest=UserTest -X
```

## ğŸ“Š Cobertura de Testes

### Funcionalidades Testadas

#### âœ… AutenticaÃ§Ã£o JWT
- Login com username/password
- GeraÃ§Ã£o de access e refresh tokens
- ValidaÃ§Ã£o de tokens
- RenovaÃ§Ã£o de tokens
- Logout stateless
- Auditoria de tentativas

#### âœ… AutorizaÃ§Ã£o RBAC
- VerificaÃ§Ã£o de permissÃµes
- Controle de acesso por roles
- PolÃ­ticas de acesso complexas
- Auditoria de acessos
- Gerenciamento de roles/permissÃµes

#### âœ… PolÃ­ticas de Acesso
- PolÃ­ticas baseadas em tempo
- PolÃ­ticas baseadas em rede (IP)
- PolÃ­ticas baseadas em atributos
- CombinaÃ§Ã£o de mÃºltiplas polÃ­ticas
- AtivaÃ§Ã£o/desativaÃ§Ã£o de polÃ­ticas

#### âœ… Auditoria
- Registro de operaÃ§Ãµes
- HistÃ³rico de acessos
- Falhas de autenticaÃ§Ã£o
- MudanÃ§as em roles/permissÃµes

## ğŸ› ï¸ ConfiguraÃ§Ã£o de Testes

### Perfil de Teste (application-test.yml)
```yaml
spring:
  profiles:
    active: test
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
  jpa:
    hibernate:
      ddl-auto: create-drop
  security:
    jwt:
      secret-key: dGVzdC1zZWNyZXQta2V5...
      expiration: 3600000
```

### DependÃªncias de Teste
- âœ… JUnit 5
- âœ… AssertJ
- âœ… Mockito
- âœ… Spring Boot Test
- âœ… Spring Security Test
- âœ… H2 Database (em memÃ³ria)

## ğŸ¯ BenefÃ­cios da Estrutura de Testes

### 1. **SeparaÃ§Ã£o por Camadas**
- Testes de domÃ­nio puros (sem dependÃªncias externas)
- Testes de aplicaÃ§Ã£o com mocks
- Testes de integraÃ§Ã£o com contexto Spring

### 2. **Clean Architecture**
- Testabilidade facilitada pela inversÃ£o de dependÃªncias
- Isolamento de responsabilidades
- Testes rÃ¡pidos e confiÃ¡veis

### 3. **Cobertura Abrangente**
- CenÃ¡rios de sucesso e falha
- ValidaÃ§Ãµes de entrada
- Tratamento de erros
- Casos extremos

### 4. **Facilidade de ManutenÃ§Ã£o**
- Testes bem organizados e nomeados
- Uso de builders e factories
- Mocks bem definidos
- DocumentaÃ§Ã£o clara

## ğŸ” Exemplos de CenÃ¡rios Testados

### AutenticaÃ§Ã£o
```java
@Test
@DisplayName("Should authenticate user successfully")
void shouldAuthenticateUserSuccessfully() {
    // Given: usuÃ¡rio ativo com credenciais vÃ¡lidas
    // When: tentativa de autenticaÃ§Ã£o
    // Then: retorna tokens JWT vÃ¡lidos e registra auditoria
}
```

### RBAC
```java
@Test
@DisplayName("Should grant access when user has permission and passes policies")
void shouldGrantAccessWhenUserHasPermissionAndPassesPolicies() {
    // Given: usuÃ¡rio com permissÃ£o e polÃ­tica que permite acesso
    // When: verificaÃ§Ã£o de acesso
    // Then: acesso concedido e auditoria registrada
}
```

### PolÃ­ticas Complexas
```java
@Test
@DisplayName("Should create complex business hours and role policy")
void shouldCreateComplexBusinessHoursAndRolePolicy() {
    // Given: polÃ­tica que combina horÃ¡rio comercial + role especÃ­fica
    // When: avaliaÃ§Ã£o da polÃ­tica
    // Then: acesso permitido apenas se ambas condiÃ§Ãµes forem atendidas
}
```

## ğŸ“ˆ PrÃ³ximos Passos

1. **Testes de Performance**: Benchmarks para operaÃ§Ãµes crÃ­ticas
2. **Testes de SeguranÃ§a**: ValidaÃ§Ã£o de vulnerabilidades
3. **Testes E2E**: CenÃ¡rios completos de usuÃ¡rio
4. **RelatÃ³rios de Cobertura**: IntegraÃ§Ã£o com SonarQube
5. **CI/CD**: ExecuÃ§Ã£o automÃ¡tica nos pipelines

## ğŸš¨ Troubleshooting

### Problemas Comuns

#### Erro de Contexto Spring
```bash
# Verificar se todas as dependÃªncias estÃ£o mockadas
mvn test -Dtest=ApplicationContextTest
```

#### Falhas de CompilaÃ§Ã£o
```bash
# Compilar antes dos testes
mvn clean compile test-compile
```

#### Problemas com H2
```bash
# Verificar configuraÃ§Ã£o de banco de teste
cat src/test/resources/application-test.yml
```

---

**ğŸ‰ Com essa estrutura de testes, o sistema SGI possui cobertura abrangente de todas as funcionalidades de autenticaÃ§Ã£o, autorizaÃ§Ã£o e polÃ­ticas de acesso, garantindo qualidade e confiabilidade do cÃ³digo!**
